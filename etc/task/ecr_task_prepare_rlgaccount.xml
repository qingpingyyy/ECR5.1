<?xml version="1.0" encoding="GB2312"?>
<!-- 任务定义文件,每个任务有一个文件构成，任务构造器可以根据此文件构造一个任务出来 -->

<task name="ECRPrepareRlgAccountTask" describe="导入企业循环贷账户信息" recovery="false"  saveHistory="true"  historyFolder="./his" >

		<executeUnits>
			<executeUnit name="ImportPayPlan" describe="导入循环贷还款计划" allowManualExecute="true" executeClass="com.amarsoft.task.units.dpx.PRHUnit">
				<extendProperties>
					<property name="unit.recordSet" value="datasource:db:ecr:select * from ECR_PAYPLAN:etc/ecr_are.xml:," />
					<property name="unit.provider" value="com.amarsoft.are.dpx.recordset.DefaultDataSourceProvider" />
					<property name="unit.handlers" value="com.amarsoft.are.dpx.recordset.UpdateDBHandler"/>
					<property name="unit.handlersThreadNumber" value="{$ARE.threadNumber}"/> 
					<property name="com.amarsoft.are.dpx.recordset.DefaultDataSourceProvider.dataSource"
						value="datasource:db:ecr:select 
									EAC.BCtrctCode as AcctCode{#账户标识码},
									max(EEP.PayDate) as PayDate{#结算日期},
									max(EEP.PeriodPayDate) as PeriodPayDate{#宽限日期},
									sum(EEP.PayCorp) as PayCorp{#应还本金},
									sum(EEP.PayInte) as PayInte{#应还利息},
									sum(EEP.PayCorpFine) as PayCorpFine{#应还本金罚息},
									sum(EEP.PayInteFine) as PayInteFine{#应还利息罚息},
									max(EEP.ActualPayDate) as ActualPayDate{#实还日期},
									sum(EEP.ActualCorp) as ActualCorp{#实还本金},
									sum(EEP.ActualInte) as ActualInte{#实还利息},
									sum(EEP.ActualCorpFine) as ActualCorpFine{#实还本金罚息},
									sum(EEP.ActualInteFine) as ActualInteFine{#实还利息罚息},
									max(EEP.PayoffStatus) as PayoffStatus{#还款标志},
									EAC.ManagerOrgID as ManagerOrgID{#管户机构编号},
									EAC.ManagerUserID as ManagerUserID{#管户用户编号},
									max(EEP.UpdateDate) as UpdateDate{#更新日期},
									'{$ARE.bizDate}' as OccurDate{#数据日期}
								from ECR_INT_PAYPLAN EEP,ECR_INT_ACCTINFO EAI,ECR_INT_ACCTCTRCT EAC
								where EEP.AcctCode = EAI.BACCTCODE and EAI.BCtrctCode = EAC.BCtrctCode 
									and ((EAC.AcctType ='R1' and '{$ARE.endDate}'='{$ARE.bizDate}' {#月底更新}) or (EAC.AcctType ='D1' and EAC.Flag ='2'))
									and (EEP.PayOffStatus='1' 
										or (EEP.PayOffStatus='0' and substr(EEP.PayDate,1,7) 
											= (select max(substr(PayDate,1,7)) from ECR_INT_PAYPLAN EIP,ECR_INT_ACCTINFO EIA 
												where EAI.BACCTCODE = EIA.BACCTCODE and EIA.BCtrctCode = EAI.BCtrctCode group by EIA.BCtrctCode)))
								group by EAC.BCtrctCode,substr(EEP.PayDate,1,7),EAC.ManagerOrgID,EAC.ManagerUserID
						" />
					<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.database" value="ecr" />		
					<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.table" value="ECR_PAYPLAN" />
					<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.keyColumns" value="AcctCode,PayDate" />
					<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.checkDBRecord" value="false" />
				</extendProperties>
			</executeUnit>
			
			<executeUnit name="ImportAccountInfo" describe="导入循环贷贷账户信息" allowManualExecute="true" executeClass="com.amarsoft.task.units.dpx.PRHUnit">
				<extendProperties>
					<property name="unit.recordSet" value="datasource:db:ecr:select * from ECR_ACCOUNTINFO:etc/ecr_are.xml:," />
					<property name="unit.handlers" value="com.amarsoft.app.pbc.ecr.dataimport.ImportAccountHandler" />
					<property name="unit.provider" value="com.amarsoft.are.dpx.recordset.DefaultDataSourceProvider" />
					<property name="unit.handlersThreadNumber" value="{$ARE.threadNumber}"/> 
					<property name="com.amarsoft.are.dpx.recordset.DefaultDataSourceProvider.dataSource" 
						     value="datasource:db:ecr:select EAC.BCtrctCode as AcctCode{#账户标识码},
						     EAC.BCtrctCode as BCtrctCode{#合同号},
						     EAC.CustomerID as CustomerID{#客户号},
						     EAC.ContractCode as ContractCode{#授信协议标识码},
						     EAC.AcctType as AcctType{#账户类型},
						     EAC.Flag as Flag{#分次放款标志},
						     EAC.Name as Name{#借款人名称},
						     EAC.IDType as IDType{#借款人身份标识类型},
						     EAC.IDNum as IDNum{#借款人身份标识号码},
						     EAC.BusiLines as BusiLines{#借贷业务大类},
						     EAC.BusiDtlLines as BusiDtlLines{#借贷业务种类细分},
						     '90' as RepayMode{#还款方式},
						     '10' as RepayFreqcy{#还款频率},
						     AA.NxtAgrrRpyDate as NxtAgrrRpyDate{#下一次约定还款日期},
						     AA.LoanTimeLimCat as LoanTimeLimCat{#借款期限分类},
						     AA.OpenDate as OpenDate{#开户日期},
						     case when EAC.AcctType ='R1' then EAC.DueDate else AA.DueDate end as DueDate{#到期日期},
						     EAC.Cy as Cy{#币种},
						     case when EAC.AcctType ='R1' then EAC.CtrCtamt else null end as AcctCredLine{#信用额度},
						     case when EAC.AcctType ='R1' then null else AA.LoanAmt end as LoanAmt{#借款金额},
						     AA.AcctBal as AcctBal{#余额},
						     AA.BalChgDat as BalChgDat{#余额变化日期},
						     AA.NormalBal as NormalBal{#正常本金余额},
						     AA.OverdBal as OverdBal{#逾期本金余额},
						     AA.Interest as Interest{#利息},
						     AA.OverdDy as OverdDy{#当前逾期天数},
						     EAC.FiveCate as FiveCate{#五级分类},
						     EAC.FiveCateAdjDate as FiveCateAdjDate{#五级分类认定日期},
						     AA.AcctStatus as AcctStatus{#账户状态},
						     EAC.ConCloseDate as CloseDate{#账户关闭日期},
						     EAC.GuarMode as GuarMode{#担保方式},
						     EAC.OthRepyGuarWay as OthRepyGuarWay{#其他还款保证方式},
						     EAC.ActInvest as ActInvest{#贷款实际投向},
						     EAC.LoaFrm as LoaFrm{#贷款发放形式},
						     EAC.FundSou as FundSou{#业务经营类型},
						     AA.AssetTrandFlag as AssetTrandFlag{#资产转让标志},
						     EAC.ApplyBusiDist as ApplyBusiDist{#业务申请地行政区划代码},
						     EAC.ManagerOrgID as ManagerOrgID{#管户机构编号},
						     EAC.ManagerUserID as ManagerUserID{#管户用户编号},
						     EAC.UpdateDate as UpdateDate{#更新日期}
						 from (select EAC.BCtrctCode as AcctCode{#账户标识码},
						     max(EAI.NxtAgrrRpyDate) as NxtAgrrRpyDate{#下一次约定还款日期},
						     max(EAI.LoanTimeLimCat) as LoanTimeLimCat{#借款期限分类},
						     min(EAI.OpenDate) as OpenDate{#开户日期},
						     max(EAI.DueDate) as DueDate{#到期日期},
						     sum(EAI.LoanAmt) as LoanAmt{#借款金额},
						     sum(EAI.AcctBal) as AcctBal{#余额},
						     max(EAI.BalChgDat) as BalChgDat{#余额变化日期},
						     sum(EAI.NormalBal) as NormalBal{#正常本金余额},
						     sum(EAI.OverdBal) as OverdBal{#逾期本金余额},
						     sum(EAI.Interest) as Interest{#利息},
						     max(EAI.OverdDy) as OverdDy{#当前逾期天数},
						     max(EAI.AcctStatus) as AcctStatus{#账户状态},
						     min(EAI.AssetTrandFlag) as AssetTrandFlag{#资产转让标志}
						   from ECR_INT_ACCTINFO EAI,ECR_INT_ACCTCTRCT EAC
						   where EAI.BCtrctCode = EAC.BCtrctCode 
						     and ((EAC.AcctType ='R1' and '{$ARE.endDate}'='{$ARE.bizDate}'){#月底更新} or (EAC.AcctType ='D1' and EAC.Flag ='2')){#统一报送的循环贷和D1分次放款账户}
						     and (EAC.ConStatus = '1' {#未结清数据}
						     	or (EAC.ConCloseDate &gt;= '{$ARE.appDate}' and EAC.ConCloseDate &gt;= '{$ARE.lastMonth}-01' and EAC.ConCloseDate &lt;= '{$ARE.bizDate}')){#近阶段结清数据}
						     and EAI.DueDate &gt; EAI.OpenDate {#到期日期大于开立日期}
						     and EAI.LoanAmt &gt; 0{#发放金额大于0}
						     and EAI.RepayFreqcy is not null{#还款频率不为空}
						   group by EAC.BCtrctCode) AA,ECR_INT_ACCTCTRCT EAC
						 where AA.AcctCode = EAC.BCtrctCode
						"/>
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ImportAccountHandler.database" value="ecr" />				
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ImportAccountHandler.table" value="ECR_ACCOUNTINFO" />
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ImportAccountHandler.keyColumns" value="AcctCode" />
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ImportAccountHandler.checkDBRecord" value="true" />
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ImportAccountHandler.updateColumns" 
					    value="AcctType,Flag,Name,IDType,IDNum,BusiDtlLines,RepayMode,RepayFreqcy,PymtPrd,NxtAgrrRpyDate,LoanTimeLimCat,OpenDate,DueDate,Cy,AcctCredLine,LoanAmt,AcctBal,BalChgDat,NormalBal,OverdBal,Interest,OverdDy,FiveCate,FiveCateAdjDate,AcctStatus,CloseDate,GuarMode,OthRepyGuarWay,ActInvest,LoaFrm,AssetTrandFlag,FundSou,ApplyBusiDist,RptDateCode,RecordFlag,ManagerOrgID,ManagerUserID,UpdateDate,OccurDate"/>
				 	<property name="com.amarsoft.app.pbc.ecr.dataimport.ImportAccountHandler.compareColumns" 
				 		value="AcctType,Flag,Name,IDType,IDNum,BusiDtlLines,RepayMode,RepayFreqcy,PymtPrd,NxtAgrrRpyDate,LoanTimeLimCat,OpenDate,DueDate,Cy,AcctCredLine,LoanAmt,AcctBal,BalChgDat,NormalBal,OverdBal,Interest,OverdDy,FiveCate,FiveCateAdjDate,AcctStatus,CloseDate,GuarMode,OthRepyGuarWay,ActInvest,LoaFrm,AssetTrandFlag,FundSou,ApplyBusiDist" />
				 </extendProperties>
			</executeUnit>	
			
			<executeUnit name="ImportEACNotExtractData" describe="导入未抽取的接口表数据" allowManualExecute="true" executeClass="com.amarsoft.task.units.dpx.PRHUnit">
					<extendProperties>
						<property name="unit.recordSet" value="datasource:db:ecr:select * from ECR_REPWARNING:etc/ecr_are.xml:," />
						<property name="unit.provider" value="com.amarsoft.are.dpx.recordset.DefaultDataSourceProvider" />
						<property name="unit.handlers" value="com.amarsoft.are.dpx.recordset.UpdateDBHandler"/>
						<property name="unit.handlersThreadNumber" value="{$ARE.threadNumber}"/>
						<property name="com.amarsoft.are.dpx.recordset.DefaultDataSourceProvider.dataSource"
								value="datasource:db:ecr:select distinct
								EAC.BCtrctCode as AcctCode,{#账户标识码}
								EAC.CustomerID as CustomerID,{#客户号}
								EAC.Name as Name,{#借款人姓名}
					     		EAC.IDType as IDType,{#借款人证件类型}
					     		EAC.IDNum as IDNum,{#借款人证件号码}
					     		'3' as WarningType,{#预警类型}
					     		'{$ARE.bizDate}' as OccurDate,{#数据日期}
					     		'ECR_INT_ACCTCTRCT ' as WarningTable{#预警表},
					     		EAC.AcctType as AcctType,{#账户类型}
					     		EAC.ManagerOrgID as ManagerOrgID{#管户机构编号},
								EAC.ManagerUserID as ManagerUserID{#管户用户编号}
					     		from ECR_INT_ACCTCTRCT  EAC,ECR_INT_ACCTINFO EAI{# EAC=合同表,EAI=借据表}
					     		where EAC.BCtrctCode = EAI.BCtrctCode
					     		and (EAC.AcctType ='R1' or (EAC.AcctType ='D1' and EAC.Flag ='2'))
					     		and not exists(select 1 from ECR_ACCOUNTINFO
					     			where AcctCode=EAC.BCtrctCode)
						"/>
						<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.database" value="ecr" />		
						<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.table" value="ECR_REPWARNING" />
						<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.keyColumns" value="AcctCode,WarningType" />
						<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.checkDBRecord" value="false" />
					</extendProperties>
				</executeUnit>
			
			<executeUnit name="ImportLCBacklist" describe="导入循环账户还款流水中间表" allowManualExecute="true" executeClass="com.amarsoft.task.units.dpx.PRHUnit">
				<extendProperties>
					<property name="unit.recordSet" value="datasource:db:ecr:select * from ECR_LCBACKLIST:etc/ecr_are.xml:," />
					<property name="unit.provider" value="com.amarsoft.are.dpx.recordset.DefaultDataSourceProvider" />
					<property name="unit.handlers" value="com.amarsoft.are.dpx.recordset.UpdateDBHandler"/>
					<property name="unit.handlersThreadNumber" value="{$ARE.threadNumber}"/> 
					<property name="com.amarsoft.are.dpx.recordset.DefaultDataSourceProvider.dataSource"
						value="datasource:db:ecr:select 
										EAI.BCtrctCode as AcctCode{#账户标识码},
										max(ELL.RpmtCode) as RpmtCode{#还款流水号},
										max(ELL.RpmtDate) as RpmtDate{#发生日期},
										sum(ELL.RpmtCorp) as RpmtCorp{#还款本金},
										sum(ELL.RpmtInst) as RpmtInst{#还款利息},
										sum(ELL.RpmtCorpFine) as RpmtCorpFine{#发生本金罚息},
										sum(ELL.RpmtInstFine) as RpmtInstFine{#发生利息罚息},
										max(ELL.RpmtType) as RpmtType{#还款形式},
										EA.ManagerOrgID as ManagerOrgID{#管户机构编号},
										EA.ManagerUserID as ManagerUserID{#管户用户编号},
										EA.UpdateDate as UpdateDate{#更新日期},
										'{$ARE.bizDate}' as OccurDate{#数据日期}
									from ECR_INT_LCBACKLIST ELL,ECR_INT_ACCTINFO EAI,ECR_ACCOUNTINFO EA
									where ELL.AcctCode = EAI.BACCTCODE 
										and EA.AcctCode = EAI.BCtrctCode 
										and EA.RecordFlag in('A','U') 
										and ((EA.AcctType ='R1' and '{$ARE.endDate}'='{$ARE.bizDate}' {#月底更新}) or (EA.AcctType='D1' and EA.Flag ='2'))
										and substr(ELL.RpmtDate,1,7) = '{$ARE.thisMonth}'
									group by EAI.BCtrctCode,EA.ManagerOrgID,EA.ManagerUserID,EA.UpdateDate
						" />
					<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.database" value="ecr" />		
					<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.table" value="ECR_LCBACKLIST" />
					<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.keyColumns" value="AcctCode,RpmtCode,RpmtDate" />
					<property name="com.amarsoft.are.dpx.recordset.UpdateDBHandler.checkDBRecord" value="false" />
				</extendProperties>
			</executeUnit>
			
			<executeUnit name="InsertEcrAcctSpectrstdspn" describe="导入企业循环借贷账户特定交易段" executeClass="com.amarsoft.task.units.dpx.PRHUnit" allowManualExecute="true">
				<extendProperties>
					<property name="unit.recordSet" value="datasource:db:ecr:select * from ECR_ACCT_SPECTRSTDSPN:etc/ecr_are.xml:,"/>
					<property name="unit.provider" value="com.amarsoft.are.dpx.recordset.DefaultDataSourceProvider" />
					<property name="unit.handlers" value="com.amarsoft.app.pbc.ecr.dataimport.ECRAcctAndGuarUpdateHandler" />
					<property name="unit.handlersThreadNumber" value="{$ARE.threadNumber}"/> 
					<property name="com.amarsoft.are.dpx.recordset.DefaultDataSourceProvider.dataSource"
						value="datasource:db:ecr:select 
							EA.CustomerID as CustomerID{#客户编号},
							EA.AcctCode as AcctCode{#账户标识码 },
							max(ESB.ChanCode) as CagOfTrdSerialNo{#交易编号 },
							ESB.ChanTranType as ChanTranType{#交易类型 },
							max(ESB.TranDate) as TranDate{#交易日期},
							sum(ESB.TranAmt) as TranAmt{#交易金额},
							max(ESB.DueTranMon) as DueTranMon{#到期日期变更月数},
							max(ESB.DetInfo) as DetInfo{#交易明细信息},
							EA.ManagerOrgID as ManagerOrgID{#管户机构编号},
							EA.ManagerUserID as ManagerUserID{#管户用户编号}
						from ECR_ACCOUNTINFO EA,ECR_INT_SPECIBUSINESS ESB,ECR_INT_ACCTINFO EAI
						where ESB.AcctCode = EAI.BACCTCODE 
							and EA.AcctCode = EAI.BCtrctCode 
							and EA.RecordFlag in('A','U') {#符合记录标志的数据}
							and ((EA.AcctType ='R1' and '{$ARE.endDate}'='{$ARE.bizDate}' {#月底更新} and ISB.ChanTranType not in ('1','4'){#R1账户不报送展期和提前还款两类特殊交易}) 
								or (EA.AcctType='D1' and EA.Flag ='2'))
						group by EA.CustomerID,EA.AcctCode,ESB.ChanTranType,EA.ManagerOrgID,EA.ManagerUserID
						"/> 
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ECRAcctAndGuarUpdateHandler.database" value="ecr" />
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ECRAcctAndGuarUpdateHandler.table" value="ECR_ACCT_SPECTRSTDSPN" />
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ECRAcctAndGuarUpdateHandler.keyColumns" value="AcctCode,CagOfTrdSerialNo" />
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ECRAcctAndGuarUpdateHandler.commitNumber" value="500" />
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ECRAcctAndGuarUpdateHandler.updateColumns" 
						      value="ChanTranType,TranDate,TranAmt,DueTranMon,DetInfo,OccurDate,RecordFlag,ManagerOrgID,ManagerUserID" />
					<property name="com.amarsoft.app.pbc.ecr.dataimport.ECRAcctAndGuarUpdateHandler.compareColumns" 
						      value="ChanTranType,TranDate,TranAmt,DueTranMon,DetInfo" />
				</extendProperties>
			</executeUnit>
		</executeUnits>
		
		<routeMap start="ImportPayPlan" >
			<route unit="ImportPayPlan" successful="ImportAccountInfo" />
	    	<route unit="ImportAccountInfo" successful="ImportEACNotExtractData" />
	    	<route unit="ImportEACNotExtractData" successful="ImportLCBacklist" />
	    	<route unit="ImportLCBacklist" successful="InsertEcrAcctSpectrstdspn" />
	    </routeMap>	
		
</task>